{% extends 'base.html' %}

{% block content %}
<style>
    body {
        margin-top: 20px;
    }
    

    .chat-online {
        color: #34ce57
    }

    .chat-offline {
        color: #e4606d
    }

    .chat-messages {
        display: flex;
        flex-direction: column;
        max-height: 800px;
        overflow-y: scroll
    }

    .chat-message-left,
    .chat-message-right {
        display: flex;
        flex-shrink: 0
    }

    .chat-message-left {
        margin-right: auto
    }

    .chat-message-right {
        flex-direction: row-reverse;
        margin-left: auto
    }

    .py-3 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
    }

    .px-4 {
        padding-right: 1.5rem !important;
        padding-left: 1.5rem !important;
    }

    .flex-grow-0 {
        flex-grow: 0 !important;
    }

    .border-top {
        border-top: 1px solid #dee2e6 !important;
    }
</style>

<section>
    <div class="py-2 px-4 border-bottom d-none d-lg-block">
        <div class="d-flex align-items-center py-1">
            <div class="position-relative">
                
                <img src="{{ recipient_id.userprofile.profile_picture.url }}" class="rounded-circle mr-1" alt="Recipient Image" width="40" height="40">
            </div>
            <div class="flex-grow-1 pl-3">
                <strong>{{ recipient_id.username }}</strong>
                <div class="text-muted small"><em>Typing...</em></div>
            </div>
        </div>
    </div>
    
    <div class="position-relative chat-background">
        <div class="chat-messages p-4">
            {% for message in messages %}
              {% if message.sender == request.user %}
                <!-- Sender message -->
                <div class="chat-message-right mb-4">
                  <div>
                    <img src="{{ request.user.userprofile.profile_picture.url }}" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                    <div class="text-muted small text-nowrap mt-2">{{ message.timestamp }}</div>
                  </div>
                  <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                    <div class="font-weight-bold mb-1">You</div>
                    {{ message.message }}
                    {% if message.file %}
                    <a href="{{ message.file.url }}">Download File</a>
                    {% endif %}
                  </div>
                </div>
              {% else %}
                <!-- Recipient message -->
                <div class="chat-message-left pb-4">
                  <div>
                    <img src="{{ recipient_id.userprofile.profile_picture.url }}" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                  </div>
                  <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                    <div class="font-weight-bold mb-1"></div>
                    {{ message.message }}
                  </div>
                  <div class="text-muted small text-nowrap mt-2">{{ message.timestamp }}</div>
                </div>
              {% endif %}
            {% endfor %}
          </div> 
        </div>         
    </div>

    <div class="flex-grow-0 py-3 px-4 border-top">
        <form id="send-message-form" method="POST" action="{% url 'send_message' recipient_id.id %}">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Send Message</button>
          </form>
    </div>


    </div>
    </div>
</section>
{% block pusher %}{% endblock  %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        // Enable pusher logging - don't include this in production
        Pusher.logToConsole = true;

        var pusher = new Pusher('99d02ed61a52d34cd27c', {
            cluster: 'mt1'
        });

        var channel = pusher.subscribe('my-channel');
        channel.bind('my-event', function (data) {
            // Handle the received message data
            var message = data.message;
            var sender = data.sender;
            var recipient = data.recipient;

            // Append the new message to the chat messages container
            var chatMessagesContainer = $('.chat-messages');
            var newMessageHtml = '';

            if (sender === "{{ request.user.username }}") {
                newMessageHtml = `
        <div class="chat-message-right mb-4">
          <div>
            <img src="{{ request.user.userprofile.profile_picture.url }}" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
            <div class="text-muted small text-nowrap mt-2">${new Date().toLocaleString()}</div>
          </div>
          <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
            ${message}
          </div>
        </div>
      `;
            } else {
                newMessageHtml = `
        <div class="chat-message-left pb-4">
          <div>
            <img src="{{ recipient_id.userprofile.profile_picture.url }}" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
          </div>
          <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
            ${message}
          </div>
          <div class="text-muted small text-nowrap mt-2">${new Date().toLocaleString()}</div>
        </div>
      `;
            }

            chatMessagesContainer.append(newMessageHtml);
            scrollToBottom(chatMessagesContainer); // Scroll to the bottom of the chat messages container
        });

        $('#send-message-form').submit(function (event) {
            event.preventDefault();  // Prevent default form submission

            var form = $(this);
            var url = form.attr('action');
            var formData = form.serialize();  // Serialize form data

            var message = form.find('#id_message').val();  // Get the value of the message input field

            $.ajax({
                type: 'POST',
                url: url,
                data: formData,
                success: function (response) {
                    console.log('Message sent successfully');  // Log success message

                    // Trigger the Pusher event
                    pusher.trigger('my-channel', 'my-event', {
                        'message': message,
                        'sender': "{{ request.user.username }}",
                        'recipient': "{{ recipient_id.username }}"
                    });

                    // Append the new message to the chat messages container
                    var chatMessagesContainer = $('.chat-messages');
                    var newMessageHtml = `
          <div class="chat-message-left pb-4">
            <div>
              <img src="{{ recipient_id.userprofile.profile_picture.url }}" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
            </div>
            <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
              ${message}
            </div>
            <div class="text-muted small text-nowrap mt-2">${new Date().toLocaleString()}</div>
          </div>
        `;

                    chatMessagesContainer.append(newMessageHtml);
                    scrollToBottom(chatMessagesContainer); // Scroll to the bottom of the chat messages container

                    form.find('#id_message').val('');  // Clear the message input field

                    if (form.find('#id_message').val() != '') {
                        alert('Message sent and input cleared.');  // Display an alert if the message input field is cleared
                    }
                },
                error: function (xhr, errmsg, err) {
                    console.log('Error sending message');  // Log error message
                }
            });
        });

        // Function to scroll to the bottom of the chat messages container
        function scrollToBottom(container) {
            container.scrollTop(container[0].scrollHeight);
        }
    });


</script>
    
  
  
  
  

{% endblock %}